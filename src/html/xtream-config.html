<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xtream API Configuration ‚Ä¢ IPTV Addon</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="dark light">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="page-config">
<header class="site-header">
    <div class="inner">
        <h1 class="app-title">Xtream Codes API</h1>
        <p class="subtitle">Connect using panel credentials and an optional custom EPG.</p>
        <nav class="top-nav">
            <a href="/" class="nav-link">Home</a>
            <a href="/html/direct-config.html" class="nav-link">Direct Mode</a>
        </nav>
    </div>
</header>

<main class="main-content narrow">
    <form id="xtreamForm" class="config-form" autocomplete="off">
        <fieldset>
            <legend>Credentials</legend>
            <div class="form-group">
                <label for="addonName">Nom de l'Addon (affichage Stremio)</label>
                <input type="text" id="addonName" name="addonName" placeholder="Ex: Mon IPTV Perso">
                <small class="hint">Laissez vide pour le nom par d√©faut.</small>
            </div>
            <div class="form-group">
                <label for="xtreamUrl">Xtream Base URL <span class="req">*</span></label>
                <input type="url" id="xtreamUrl" name="xtreamUrl" required placeholder="http://panel.example.com:8080">
                <small class="hint">Do not include a trailing slash.</small>
            </div>
            <div class="form-group">
                <label for="xtreamUsername">Username <span class="req">*</span></label>
                <input type="text" id="xtreamUsername" name="xtreamUsername" required>
            </div>
            <div class="form-group password-group">
                <label for="xtreamPassword">Password <span class="req">*</span></label>
                <div class="pwd-wrapper">
                    <input type="password" id="xtreamPassword" name="xtreamPassword" required>
                    <button type="button" id="togglePwd" class="btn tiny ghost">Show</button>
                </div>
            </div>
        </fieldset>

<fieldset id="homeCategoriesFieldset">
    <legend>Personnalisation Accueil (Rails Stremio)</legend>
    <p class="hint">Chargez vos cat√©gories pour cr√©er vos propres rails personnalis√©s sur l'accueil de Stremio.</p>
    
    <button type="button" id="btnLoadCats" class="btn secondary small" style="margin-bottom: 15px;">üîç 1. Charger mes cat√©gories</button>

    <div id="catSelectors" class="hidden">
        <div style="margin-bottom: 20px;">
            <label>üé¨ Rails Films personnalis√©s</label>
            <div id="movieContainer"></div>
            <button type="button" class="btn tiny ghost" onclick="addSelector('movie')">+ Ajouter un rail de films</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label>üçø Rails S√©ries personnalis√©s</label>
            <div id="seriesContainer"></div>
            <button type="button" class="btn tiny ghost" onclick="addSelector('series')">+ Ajouter un rail de s√©ries</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label>üì∫ Rails Cha√Ænes personnalis√©s</label>
            <div id="tvContainer"></div>
            <button type="button" class="btn tiny ghost" onclick="addSelector('tv')">+ Ajouter un rail de cha√Ænes</button>
        </div>
    </div>

    <div id="blacklistSection" class="hidden" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <label>üö´ Masquer des cat√©gories (D√©couvrir)</label>
        <p class="hint">Cochez les cat√©gories √† masquer. Utilisez les filtres pour trier par type.</p>
    
        <div style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
            <button type="button" class="btn tiny ghost active-filter" id="btnFilterAll" onclick="filterBlacklist('all')" style="border-bottom: 2px solid #BD5FFF;">Tout</button>
            <button type="button" class="btn tiny ghost" id="btnFilterLive" onclick="filterBlacklist('live')">Live</button>
            <button type="button" class="btn tiny ghost" id="btnFilterMovie" onclick="filterBlacklist('movie')">VOD</button>
            <button type="button" class="btn tiny ghost" id="btnFilterSeries" onclick="filterBlacklist('series')">S√©ries</button>
        </div>

        <div style="margin-bottom: 10px;">
            <button type="button" class="btn tiny ghost" onclick="toggleVisibleBlacklist(true)">Tout cocher visible</button>
            <button type="button" class="btn tiny ghost" onclick="toggleVisibleBlacklist(false)">Tout d√©cocher visible</button>
        </div>

        <div id="blacklistContainer" style="max-height: 250px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        </div>
    </div>
    <div id="catLoaderStatus" class="hint"></div>
</fieldset>

        <fieldset>
            <legend>EPG Options</legend>
            <div class="form-group checkbox-line">
                <input type="checkbox" id="enableEpg" name="enableEpg" checked>
                <label class="checkbox-label" for="enableEpg" class="inline">Enable EPG</label>
            </div>
            <div id="epgModeBlock" class="form-group">
                <label class="group-label">EPG Source Mode</label>
                <div class="radio-group">
                    <label class="checkbox-line">
                        <input type="radio" name="epgMode" value="xtream" checked>
                        <span class="checkbox-label">Panel XMLTV</span>
                    </label>
                    <label class="checkbox-line">
                        <input type="radio" name="epgMode" value="custom">
                        <span class="checkbox-label">Custom EPG URL</span>
                    </label>
                </div>
            </div>
            <div class="form-group hidden" id="customEpgGroup">
                <label for="customEpgUrl">Custom EPG XML URL</label>
                <input type="url" id="customEpgUrl" name="customEpgUrl" placeholder="https://example.com/epg.xml">
            </div>
            <div class="form-group">
                <label for="epgOffsetHours">EPG Offset (hours)</label>
                <input type="number" step="0.25" id="epgOffsetHours" name="epgOffsetHours" placeholder="0">
            </div>
        </fieldset>

        <fieldset>
            <legend>Diagnostics</legend>
            <div class="form-group checkbox-line">
                <input type="checkbox" id="debugMode" name="debugMode">
                <label class="checkbox-label" for="debugMode" class="inline">Enable Debug Logging</label>
            </div>
        </fieldset>

        <div class="form-actions">
            <button type="submit" class="btn primary wide">Install / Update (Xtream)</button>
            <a href="/html/direct-config.html" class="btn subtle">Switch to Direct</a>
        </div>
        <div class="donate-inline under-form">
            <p class="hint" style="margin:.4rem 0 .6rem;">Enjoying the addon? Support development:</p>
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="K3QSoR2" data-color="#BD5FFF" data-emoji="‚òï" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>
        </div>
    </form>

    <section class="info-panel">
        <h3>Hints</h3>
        <ul class="feature-list">
            <li>JSON mode fetches live, VOD and (optional) panel EPG.</li>
            <li>M3U mode parses the entire exported playlist client-side.</li>
            <li>Series (shows) are supported in both modes.</li>
        </ul>
    </section>
</main>

<footer class="site-footer">
    <div class="inner">
        <p>&copy; 2025 M3U/EPG Addon ‚Ä¢ Made with ‚ù§Ô∏è by Inside4ndroid</p>
    </div>
</footer>

<div id="loaderOverlay" class="overlay hidden">
    <div class="overlay-box">
        <header class="overlay-header">
            <h2 id="loaderMessage">Starting‚Ä¶</h2>
            <p class="overlay-sub" id="progressText">0%</p>
        </header>
        <div class="progress-track"><div id="progressBar" class="progress-fill" style="width:0%"></div></div>
        <pre id="statusDetails" class="status-log" aria-live="polite"></pre>
        <div class="overlay-actions">
            <button id="openStremioBtn" class="btn success" disabled>Open in Stremio</button>
            <button id="copyManifestBtn" class="btn secondary" disabled>Copy Manifest URL</button>
        </div>
    </div>
</div>

<script src="/js/configure-common.js"></script>
<script src="/js/xtream-config.js"></script>
<script>
let categoryData = { movies: [], lives: [], series: [] };

function addSelector(type, defaultValue = "") {
    const container = document.getElementById(type + 'Container');
    const div = document.createElement('div');
    div.style = "display: flex; gap: 10px; margin-bottom: 8px; align-items: center;";
    const select = document.createElement('select');
    select.className = "home-category-select " + type;
    select.style = "flex-grow: 1;";
    select.innerHTML = `<option value="">-- Choisir une cat√©gorie --</option>`;
    
    let list = (type === 'movie') ? categoryData.movies : (type === 'series' ? categoryData.series : categoryData.lives);
    list.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        if(name === defaultValue) opt.selected = true;
        select.appendChild(opt);
    });

    const btnRemove = document.createElement('button');
    btnRemove.type="button"; btnRemove.innerHTML="‚úï"; btnRemove.className="btn tiny danger";
    btnRemove.style="padding: 5px 10px;"; btnRemove.onclick=() => div.remove();
    div.appendChild(select); div.appendChild(btnRemove);
    container.appendChild(div);
}

document.getElementById('btnLoadCats').addEventListener('click', async () => {
    const url = document.getElementById('xtreamUrl').value;
    const user = document.getElementById('xtreamUsername').value;
    const pass = document.getElementById('xtreamPassword').value;
    const status = document.getElementById('catLoaderStatus');

    if(!url || !user || !pass) return alert("Remplissez les acc√®s.");
    status.innerText = "‚è≥ Connexion...";
    
    try {
        const fetchUrl = `/health?action=getCategories&url=${encodeURIComponent(url)}&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`;
        const response = await fetch(fetchUrl);
        const data = await response.json();

        categoryData.movies = data.movies || [];
        categoryData.lives = data.lives || [];
        categoryData.series = data.series || [];

        document.getElementById('movieContainer').innerHTML = '';
        document.getElementById('tvContainer').innerHTML = '';
        document.getElementById('seriesContainer').innerHTML = '';

        addSelector('movie'); addSelector('series'); addSelector('tv');
        renderBlacklist();

        document.getElementById('catSelectors').classList.remove('hidden');
        status.innerText = `‚úÖ Charg√©es (VOD: ${categoryData.movies.length}, S√©ries: ${categoryData.series.length}, Live: ${categoryData.lives.length})`;
    } catch (e) { status.innerText = "‚ùå Erreur"; }
});

function renderBlacklist() {
    const container = document.getElementById('blacklistContainer');
    container.innerHTML = '';
    
    const createItem = (cat, type, color) => {
        const label = document.createElement('label');
        label.className = "blacklist-label";
        label.setAttribute('data-type', type);
        label.style = "display: flex; align-items: center; gap: 5px; font-size: 0.8em; cursor: pointer;";
        label.innerHTML = `<input type="checkbox" class="blacklist-item" value="${cat}"> 
                           <span style="color:${color}; font-weight:bold; font-size:0.7em;">[${type.toUpperCase()}]</span> 
                           <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${cat}</span>`;
        return label;
    };

    categoryData.lives.sort().forEach(c => container.appendChild(createItem(c, 'live', '#4a90e2')));
    categoryData.movies.sort().forEach(c => container.appendChild(createItem(c, 'movie', '#BD5FFF')));
    categoryData.series.sort().forEach(c => container.appendChild(createItem(c, 'series', '#27ae60')));
    document.getElementById('blacklistSection').classList.remove('hidden');
}

function filterBlacklist(type) {
    const buttons = ['All', 'Live', 'Movie', 'Series'];
    buttons.forEach(b => document.getElementById('btnFilter' + b).style.borderBottom = "none");
    document.getElementById('btnFilter' + type.charAt(0).toUpperCase() + type.slice(1)).style.borderBottom = "2px solid #BD5FFF";

    document.querySelectorAll('.blacklist-label').forEach(el => {
        el.style.display = (type === 'all' || el.getAttribute('data-type') === type) ? 'flex' : 'none';
    });
}

function toggleVisibleBlacklist(checked) {
    document.querySelectorAll('.blacklist-label').forEach(el => {
        if(el.style.display !== 'none') el.querySelector('input').checked = checked;
    });
}
</script>
</body>
</html>